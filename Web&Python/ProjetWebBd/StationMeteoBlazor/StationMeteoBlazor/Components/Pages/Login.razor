@using Microsoft.AspNetCore.Components.Authorization
@using StationMeteoBlazor.Data
@using StationMeteoBlazor.Models
@rendermode InteractiveServer
@inject LoginService Service
@using StationMeteoBlazor.Authentification
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JS
@page "/login"

<PageTitle>Connexion</PageTitle>

<div class="login-hero position-relative">
    <div class="hero-overlay"></div>
    <div class="container py-5 position-relative">
        <div class="row justify-content-center">
            <div class="col-xl-5 col-lg-6">
                <div class="glass-card shadow-lg">
                    <div class="text-center mb-4">
                        <div class="login-icon mb-3">
                            <i class="bi bi-cloud-sun-fill"></i>
                        </div>
                        <h2 class="fw-bold mb-1">Bienvenue</h2>
                        <p class="text-muted mb-0 small">Connectez-vous pour accéder à votre station météo intelligente.</p>
                    </div>

                    <div class="mb-3">
                        <label for="email" class="form-label fw-semibold">Adresse courriel</label>
                        <div class="input-group fancy-input">
                            <span class="input-group-text bg-white"><i class="bi bi-envelope"></i></span>
                            <input type="email" id="email" autocomplete="username"
                                   class="form-control"
                                   placeholder="exemple@cegepjonquiere.ca"
                                   @bind="user.Email">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="motdepasse" class="form-label fw-semibold d-flex justify-content-between align-items-center">
                            <span>Mot de passe</span>
                            <button type="button" class="btn btn-link p-0 small" @onclick="ToggleMask">
                                <i class="bi @(showPassword ? "bi-eye-slash" : "bi-eye")"></i> Afficher
                            </button>
                        </label>
                        <div class="input-group fancy-input">
                            <span class="input-group-text bg-white"><i class="bi bi-lock"></i></span>
                            <input type="@(_inputType)" id="motdepasse" autocomplete="current-password"
                                   class="form-control"
                                   placeholder="Votre mot de passe"
                                   @bind="user.MotDePasseNonHash">
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="remember" @bind="rememberMe">
                            <label class="form-check-label small" for="remember">Se souvenir de moi</label>
                        </div>
                        <a href="#" class="small text-decoration-none">Mot de passe oublié ?</a>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg gradient-btn shadow-sm"
                                disabled="@isAuthenticating"
                                @onclick="ConnexionAsync">
                            @if (isAuthenticating)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>Connexion...</span>
                            }
                            else
                            {
                                <span><i class="bi bi-box-arrow-in-right me-1"></i> Se connecter</span>
                            }
                        </button>
                    </div>

                    <div class="text-center mt-3">
                        <small class="text-muted">Pas encore de compte ?
                            <a href="/register" class="text-decoration-none fw-semibold">Inscription</a>
                        </small>
                    </div>

                    @if (!string.IsNullOrEmpty(message))
                    {
                        <div class="alert mt-4 py-2 px-3 fade-in @(messageOk ? "alert-success" : "alert-danger")">
                            <i class="bi @(messageOk ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill") me-1"></i>
                            @message
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-wave">
        <svg viewBox="0 0 1200 120" preserveAspectRatio="none">
            <path d="M985.66,92.83C906.67,72,823.78,31,743.84,14.19c-82.26-17.34-168.06-16.33-250.45.39-57.86,11.73-114,31.07-172,41.86A600.21,600.21,0,0,1,0,27.35V120H1200V95.83C1132.19,118.92,1055.71,111.31,985.66,92.83Z"
                  fill="#fff"></path>
        </svg>
    </div>
</div>

@code {
    private string message = string.Empty;
    private bool messageOk;
    private bool isAuthenticating;
    private int Idutilisateur;
    private string role = string.Empty;
    private Utilisateur user = new Utilisateur();
    private bool rememberMe;
    private bool showPassword;
    private string _inputType => showPassword ? "text" : "password";

    private async Task ConnexionAsync()
    {
        if (isAuthenticating) return;
        isAuthenticating = true;
        message = string.Empty;
        messageOk = false;

        try
        {
            var result = await Service.SeConnecter(user.Email, user.MotDePasseNonHash);
            Idutilisateur = result.Id;
            role = result.Role;

            if (Idutilisateur > 0)
            {
                var connexAuth = AuthStateProvider as CustomAuthenticationStateProvider;
                if (connexAuth != null)
                {
                    await connexAuth.UpdateAuthenticationState(new UserSession
                    {
                        UserName = user.Email,
                        Role = role,
                        UserId = Idutilisateur
                    });
                }

                messageOk = true;
                message = "Connexion réussie. Redirection...";
                await Task.Delay(700);

                if (role == "User")
                    Navigation.NavigateTo("/capteurs");
                else
                    Navigation.NavigateTo("/admin-dashboard");
            }
            else
            {
                messageOk = false;
                message = "Identifiants invalides. Vérifiez votre courriel ou mot de passe.";
            }
        }
        catch (Exception ex)
        {
            messageOk = false;
            message = $"Erreur : {ex.Message}";
        }
        finally
        {
            isAuthenticating = false;
        }
    }

    private void ToggleMask() => showPassword = !showPassword;
}

<style>
    .login-hero {
        min-height:100vh;
        background:
            radial-gradient(circle at 20% 20%, rgba(102,126,234,.35), transparent 60%),
            radial-gradient(circle at 85% 30%, rgba(118,75,162,.35), transparent 65%),
            linear-gradient(135deg,#667eea,#764ba2);
        position:relative;
        overflow:hidden;
    }
    .hero-overlay { position:absolute;inset:0; backdrop-filter: blur(2px); }
    .glass-card {
        background:rgba(255,255,255,.82);
        border-radius:24px;
        padding:2.2rem 2rem 2rem;
        position:relative;
        overflow:hidden;
    }
    .glass-card:before {
        content:"";position:absolute;inset:0;
        background:
            linear-gradient(115deg,rgba(255,255,255,.6),rgba(255,255,255,.15)),
            radial-gradient(circle at 80% 10%,rgba(102,126,234,.25),transparent 60%);
        mix-blend-mode: screen;
        pointer-events:none;
    }
    .login-icon {
        width:70px;height:70px;border-radius:18px;
        background:linear-gradient(135deg,#667eea,#764ba2);
        display:flex;align-items:center;justify-content:center;
        color:#fff;font-size:2rem;
        box-shadow:0 8px 24px rgba(0,0,0,.18);
        animation: floatPulse 4s ease-in-out infinite;
    }
    .fancy-input .form-control { border-top-right-radius:12px; border-bottom-right-radius:12px; }
    .fancy-input .input-group-text { border-top-left-radius:12px; border-bottom-left-radius:12px; border-right:0; }
    .gradient-btn { background:linear-gradient(135deg,#667eea,#764ba2); border:none; }
    .gradient-btn:hover { filter:brightness(1.08); }
    .bottom-wave { position:absolute;bottom:0;left:0;width:100%;line-height:0; }
    .bottom-wave svg { display:block;width:100%;height:80px; }

    .fade-in { animation: fadeIn .5s ease; }

    @@keyframes fadeIn {
        from { opacity:0; transform:translateY(10px); }
        to { opacity:1; transform:translateY(0); }
    }
    @@keyframes floatPulse {
        0%, 100% { transform:translateY(0); }
        50% { transform:translateY(-8px); }
    }

    @@media (max-width: 576px) {
        .glass-card { padding:1.7rem 1.4rem 1.4rem; }
        .login-icon { width:60px;height:60px;font-size:1.6rem; }
    }

    body.dark-mode .login-hero {
        background:
            radial-gradient(circle at 20% 20%, rgba(50,65,120,.55), transparent 60%),
            radial-gradient(circle at 85% 30%, rgba(80,50,110,.55), transparent 65%),
            linear-gradient(135deg,#2c3e50,#4b486e);
    }
    body.dark-mode .glass-card { background:rgba(40,40,48,.85); color:#e4e4e4; }
    body.dark-mode .glass-card:before {
        background:
            linear-gradient(115deg,rgba(255,255,255,.05),rgba(255,255,255,.02)),
            radial-gradient(circle at 80% 10%,rgba(110,90,200,.25),transparent 60%);
    }
    body.dark-mode .gradient-btn { background:linear-gradient(135deg,#4e7cf8,#7b5dfb); }
</style>