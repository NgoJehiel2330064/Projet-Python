@using Microsoft.AspNetCore.Components.Authorization
@using StationMeteoBlazor.Authentification
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@implements IDisposable

<!-- Navbar -->
<nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
        <!-- Toggle button -->
        <button
            data-mdb-collapse-init
            class="navbar-toggler"
            type="button"
            data-mdb-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent"
            aria-expanded="false"
            aria-label="Toggle navigation">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Collapsible wrapper -->
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <!-- Navbar brand -->
            <a class="navbar-brand mt-2 mt-lg-0" href="/">
                <img
                    src="https://mdbcdn.b-cdn.net/img/logo/mdb-transaprent-noshadows.webp"
                    height="15"
                    alt="MDB Logo"
                    loading="lazy" />
            </a>

            <AuthorizeView>
                <Authorized Context="mainAuth">
                    <!-- Left links - Menu dynamique selon le rôle -->
                    <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
                        <AuthorizeView Roles="User">
                            <Authorized Context="userAuth">
                                    <li class="p-2 nav-item">
                                        <a class="nav-link" href="/capteurs">📊 Dashboard</a>
                                    </li>
                                    <li class="p-2 nav-item">
                                        <a class="nav-link" href="/support">🎫 Support</a>
                                    </li>
                                </Authorized>
                            </AuthorizeView>

                            <AuthorizeView Roles="Admin">
                                <Authorized Context="adminAuth">
                                    <li class="p-2 nav-item">
                                        <a class="nav-link" href="/admin-dashboard">🏠 Dashboard Admin</a>
                                    </li>
                                    <li class="p-2 nav-item">
                                        <a class="nav-link" href="/support-admin">🎫 Gestion Tickets</a>
                                    </li>
                                </Authorized>
                        </AuthorizeView>
                    </ul>
                </Authorized>

                <NotAuthorized>
                    <!-- Menu vide pour les utilisateurs non connectés -->
                    <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
                        <li class="p-2 nav-item">
                            <a class="nav-link" href="/login">🔐 Connexion</a>
                        </li>
                    </ul>
                </NotAuthorized>
            </AuthorizeView>
        </div>
        <!-- Collapsible wrapper -->

        <!-- Right elements - Visible uniquement si connecté -->
        <AuthorizeView>
            <Authorized Context="avatarAuth">
                <div class="d-flex align-items-center">
                    <!-- Notifications -->
                    <div class="badge-notification me-3">
                        <i class="bi bi-bell">
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                9+
                                <span class="visually-hidden">unread notifications</span>
                            </span>
                        </i>
                    </div>

                    <!-- Avatar -->
                    <div class="dropdown">
                        <a
                            data-mdb-dropdown-init
                            class="dropdown-toggle d-flex align-items-center hidden-arrow"
                            href="#"
                            id="navbarDropdownMenuAvatar"
                            role="button"
                            aria-expanded="false">
                            <img
                                src="https://mdbcdn.b-cdn.net/img/new/avatars/2.webp"
                                class="rounded-circle"
                                height="25"
                                alt="Avatar utilisateur"
                                loading="lazy" />
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownMenuAvatar">
                            <li>
                                <a class="dropdown-item" href="#">
                                    <i class="bi bi-person"></i> @avatarAuth.User.Identity?.Name
                                </a>
                            </li>
                            <li><hr class="dropdown-divider" /></li>
                            <li>
                                <a class="dropdown-item" href="#" @onclick="DeconnexionAsync" @onclick:preventDefault="true">
                                    <i class="bi bi-box-arrow-right"></i> Déconnexion
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </Authorized>
        </AuthorizeView>
    </div>
    <!-- Container wrapper -->
</nav>
<!-- Navbar -->

@code {
    private async Task DeconnexionAsync()
    {
        var customAuth = AuthStateProvider as CustomAuthenticationStateProvider;
        if (customAuth != null)
        {
            await customAuth.LogoutAsync();
            Navigation.NavigateTo("/login", true);
        }
    }

    protected override void OnInitialized()
    {
        AuthStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
    }

    private void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AuthStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }
}

